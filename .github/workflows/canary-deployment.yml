# This is a basic workflow to help you get started with Actions

name: Canary Deployment

# Controls when the workflow will run
on:
  # push:
  #   branches:
  #     - "master"
  #     - "task/**"
  # pull_request:
  #   branches:
  #     - "master"
  #     - "task/**"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  canary_deployment:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure Kubernetes set context
        uses: Azure/aks-set-context@v3
        with:
          # Resource Group Name
          resource-group: my-aks-rg
          # AKS Cluster Name
          cluster-name: my-aks-cluster-1
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest
      - name: kubectl version check
        run: |
          kubectl version

      - name: install istio
        run: |
          curl -L https://istio.io/downloadIstio | sh -
          cd istio-1.*
          export PATH=$PWD/bin:$PATH
          istioctl install --set profile=demo -y
          kubectl label namespace default istio-injection=enabled

          
      - name: kubectl deploy
        run: |
          cd "Kubernetes/Deployment strategies/Canary"
          kubectl apply -f v1.yaml
          kubectl apply -f v2.yaml
          kubectl apply -f svc.yaml
          kubectl apply -f istio.yaml
